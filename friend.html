<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô - MoneySkillz</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Kanit', sans-serif; background-color: #f7fafc; color: #2d3748; padding: 24px; margin: 0; line-height: 1.6; }
    h2 { color: #13bba9; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }
    .container { max-width: 500px; margin: 24px auto; }
    .box { background-color: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); margin-bottom: 24px; }
    input[type="text"] { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e0; margin-right: 8px; width: calc(100% - 110px); font-family: 'Kanit'; font-size: 1em; }
    button { background-color: #13bba9; color: #fff; border: none; border-radius: 8px; padding: 10px 16px; cursor: pointer; font-family: 'Kanit'; font-size: 1em; transition: background-color 0.2s; }
    button:hover { background-color: #0f9a8d; }
    button.accept { background-color: #48bb78; }
    button.accept:hover { background-color: #38a169; }
    button.decline { background-color: #f56565; }
    button.decline:hover { background-color: #e53e3e; }
    ul { list-style: none; padding: 0; margin: 0; }
    li { background-color: #f1fefb; border-radius: 8px; padding: 12px 16px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
    .msg { color: #4a5568; margin: 12px 0; font-size: 0.9em; }
    .user-info { display: flex; flex-direction: column; }
    .user-info b { font-size: 1.1em; }
    .user-info span { font-size: 0.8em; color: #718096; }
    .button-group { display: flex; gap: 8px; }
    .top-left-back-btn { position: fixed; top: 20px; left: 20px; width: 50px; height: 50px; background: rgba(255, 255, 255, 0.8); color: #00796B; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2em; text-decoration: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); backdrop-filter: blur(5px); transition: all 0.2s; }
    .top-left-back-btn:hover { transform: scale(1.1); }
    @media (max-width: 600px) {
      .box { padding: 16px; }
      input[type="text"] { width: 100%; margin: 0 0 10px 0; }
    }
  </style>
</head>
<body>
  <a href="dashboard.html" class="top-left-back-btn">‚Üê</a>

  <div class="container">
    <div class="box">
      <h2>üîó ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h2>
      <div>
        <input id="friendSearchInput" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô">
        <button onclick="searchFriend()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <div id="friendSearchResult" class="msg"></div>
      </div>
    </div>

    <div class="box">
      <h2>üì® ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h2>
      <ul id="friendRequestsList"><li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà</li></ul>
    </div>

    <div class="box">
      <h2>üë´ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
      <ul id="friendsList"><li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</li></ul>
    </div>
  </div>

  <script type="module">
    // Import functions from the Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, updateDoc, arrayUnion, arrayRemove, writeBatch, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY", // ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      authDomain: "YOUR_AUTH_DOMAIN", // ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      projectId: "YOUR_PROJECT_ID", // ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      storageBucket: "YOUR_STORAGE_BUCKET", // ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      appId: "YOUR_APP_ID" // ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUserId = null;
    let unsubscribeRequests = null;
    let unsubscribeFriends = null;

    // Listen for authentication state changes
    onAuthStateChanged(auth, user => {
      if (user) {
        currentUserId = user.uid;
        // Start listening for real-time updates
        listenForFriendData();
      } else {
        console.log("User not logged in. Redirecting...");
        window.location.href = "./login.html"; // <-- FIXED HERE
      }
    });

    // --- All functions are now global ---
    window.searchFriend = async () => {
      const searchInput = document.getElementById("friendSearchInput").value.trim();
      const resultDiv = document.getElementById("friendSearchResult");

      if (!searchInput) return;
      resultDiv.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";

      try {
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("email", "==", searchInput));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          resultDiv.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ";
          return;
        }

        const foundUser = querySnapshot.docs[0];
        const foundUserId = foundUser.id;
        const foundUserData = foundUser.data();

        if (foundUserId === currentUserId) {
          resultDiv.textContent = "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ";
          return;
        }

        resultDiv.innerHTML = `
          <div class="user-info"><b>${foundUserData.name || 'N/A'}</b><span>${foundUserData.email}</span></div>
          <button onclick="sendFriendRequest('${foundUserId}')">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
        `;
        resultDiv.style.display = 'flex';
        resultDiv.style.justifyContent = 'space-between';
        resultDiv.style.alignItems = 'center';

      } catch (error) {
        console.error("Error searching for friend:", error);
        resultDiv.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤";
      }
    };

    window.sendFriendRequest = async (targetId) => {
        const resultDiv = document.getElementById("friendSearchResult");
        try {
            const targetUserRef = doc(db, "users", targetId);
            const currentUserRef = doc(db, "users", currentUserId);

            const targetDoc = await getDoc(targetUserRef);
            if (!targetDoc.exists()) {
                resultDiv.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ";
                return;
            }
            const targetData = targetDoc.data();

            if (targetData.friends && targetData.friends.includes(currentUserId)) {
                 resultDiv.textContent = "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß";
                 return;
            }
             if (targetData.friendRequests && targetData.friendRequests.includes(currentUserId)) {
                 resultDiv.textContent = "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß";
                 return;
            }

            await updateDoc(targetUserRef, {
                friendRequests: arrayUnion(currentUserId)
            });
            resultDiv.textContent = "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß!";
        } catch (error) {
            console.error("Error sending friend request:", error);
            resultDiv.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠";
        }
    };
    
    window.acceptFriend = async (requesterId) => {
        const batch = writeBatch(db);
        
        // Reference to current user's document
        const currentUserRef = doc(db, "users", currentUserId);
        batch.update(currentUserRef, {
            friends: arrayUnion(requesterId),
            friendRequests: arrayRemove(requesterId)
        });

        // Reference to requester's document
        const requesterRef = doc(db, "users", requesterId);
        batch.update(requesterRef, {
            friends: arrayUnion(currentUserId)
        });

        try {
            await batch.commit();
            console.log("Friend accepted.");
        } catch (error) {
            console.error("Error accepting friend request:", error);
        }
    };
    
    window.declineFriend = async (requesterId) => {
        const currentUserRef = doc(db, "users", currentUserId);
        try {
            await updateDoc(currentUserRef, {
                friendRequests: arrayRemove(requesterId)
            });
            console.log("Friend request declined.");
        } catch (error) {
            console.error("Error declining friend request:", error);
        }
    };

    window.removeFriend = async (friendId) => {
        // In a real app, use a custom modal instead of confirm()
        if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ?")) return;

        const batch = writeBatch(db);

        const currentUserRef = doc(db, "users", currentUserId);
        batch.update(currentUserRef, {
            friends: arrayRemove(friendId)
        });

        const friendRef = doc(db, "users", friendId);
        batch.update(friendRef, {
            friends: arrayRemove(currentUserId)
        });
        
        try {
            await batch.commit();
            console.log("Friend removed.");
        } catch (error) {
            console.error("Error removing friend: ", error);
        }
    };

    // Main function to setup real-time listeners
    function listenForFriendData() {
        if (unsubscribeRequests) unsubscribeRequests();
        if (unsubscribeFriends) unsubscribeFriends();

        const currentUserRef = doc(db, "users", currentUserId);

        // Listener for friend requests and friends list
        unsubscribeRequests = onSnapshot(currentUserRef, async (docSnap) => {
            if (docSnap.exists()) {
                const userData = docSnap.data();
                await renderFriendRequests(userData.friendRequests || []);
                await renderFriendsList(userData.friends || []);
            } else {
                console.log("Current user document not found!");
            }
        }, (error) => {
            console.error("Error listening to user document:", error);
        });
    }

    async function renderFriendRequests(requestIds) {
        const listElement = document.getElementById("friendRequestsList");
        if (requestIds.length === 0) {
            listElement.innerHTML = '<li>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà</li>';
            return;
        }

        let html = '';
        for (const id of requestIds) {
            const userDoc = await getDoc(doc(db, "users", id));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                html += `
                    <li>
                        <div class="user-info"><b>${userData.name}</b><span>${userData.email}</span></div>
                        <div class="button-group">
                            <button class="accept" onclick="acceptFriend('${id}')">‡∏£‡∏±‡∏ö</button>
                            <button class="decline" onclick="declineFriend('${id}')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                        </div>
                    </li>
                `;
            }
        }
        listElement.innerHTML = html;
    }

    async function renderFriendsList(friendIds) {
        const listElement = document.getElementById("friendsList");
        if (friendIds.length === 0) {
            listElement.innerHTML = '<li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</li>';
            return;
        }

        let html = '';
        for (const id of friendIds) {
            const userDoc = await getDoc(doc(db, "users", id));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                html += `
                    <li>
                        <div class="user-info"><b>${userData.name}</b><span>${userData.email}</span></div>
                        <button class="decline" onclick="removeFriend('${id}')">‡∏•‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</button>
                    </li>
                `;
            }
        }
        listElement.innerHTML = html;
    }

  </script>
</body>
</html>
