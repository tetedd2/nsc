<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>MoneySkillz ‚Äì ‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏Å‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="theme-darkmode.css">
  <style>
    html, body {
      margin: 0; padding: 0;
      background: linear-gradient(135deg, #e0f7fa 80%, #b2ebf2 100%);
      font-family: 'Kanit', sans-serif;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
    }
    .main-container {
      max-width: 430px;
      margin: 0 auto;
      margin-top: 42px;
      margin-bottom: 42px;
      padding: 24px 12px 24px 12px;
      border-radius: 22px;
      background: rgba(255,255,255,0.69);
      box-shadow: 0 8px 32px 0 rgba(0,0,0,0.11), 0 2px 6px #b2dfdb44;
      backdrop-filter: blur(9px);
      border: 1.7px solid rgba(120,200,200,0.10);
      min-height: 85vh;
      display: flex; flex-direction: column; align-items: center;
      justify-content: flex-start;
      overflow-x: hidden;
    }
    .logo-circle {
      width: 76px; height: 76px; background: #23b1ab;
      border-radius: 50%; display: flex;
      align-items: center; justify-content: center;
      margin: 0 auto 18px auto;
      box-shadow: 0 2px 17px #23b1ab42;
    }
    .logo-circle span {
      color: #fff; font-size: 2.7em; font-weight: bold; letter-spacing: 1px;
      text-shadow: 0 3px 18px #ffffff44;
    }
    .app-title {
      font-size: 1.8em;
      font-weight: bold;
      color: #00796b;
      margin-bottom: 3px;
      text-align: center;
      letter-spacing: 1px;
    }
    .app-desc {
      color: #008c7d;
      text-align: center;
      font-size: 1.08em;
      margin-bottom: 24px;
      margin-top: 2px;
      font-weight: 400;
    }
    .menu-list {
      display: flex; flex-direction: column; gap: 17px;
      width: 100%;
      margin-top: 8px;
      box-sizing: border-box;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏á‡πà‡∏≤‡∏¢, ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á, ‡∏¢‡∏≤‡∏Å (‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô) */
    .menu-btn-common {
      display: flex; align-items: center;
      width: 100%;
      box-sizing: border-box;
      padding: 17px 18px;
      background-color: #23b1ab; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
      color: #fff;
      font-weight: 700;
      font-size: 1.1em;
      border: none; border-radius: 14px;
      cursor: pointer;
      transition: background 0.17s, transform 0.14s;
      outline: none;
      letter-spacing: 0.5px;
      text-align: left;
      position: relative;
      margin: 0;
      justify-content: flex-start;
      text-decoration: none;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ï‡πâ‡∏° (‡∏™‡∏µ‡∏™‡πâ‡∏°) */
    .menu-btn-timed {
      display: flex; align-items: center;
      width: 100%;
      box-sizing: border-box;
      padding: 17px 18px;
      background-color: #ff9800; /* ‡∏™‡∏µ‡∏™‡πâ‡∏° */
      color: #fff;
      font-weight: 700;
      font-size: 1.1em;
      border: none; border-radius: 14px;
      cursor: pointer;
      transition: background 0.17s, transform 0.14s;
      outline: none;
      letter-spacing: 0.5px;
      text-align: left;
      position: relative;
      margin: 0;
      justify-content: flex-start;
      text-decoration: none;
    }

    /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover */
    .menu-btn:hover {
      transform: scale(1.05); /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏ï‡∏≠‡∏ô hover */
    }

    /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î */
    .menu-btn:active {
      transform: scale(0.97); /* ‡∏Ç‡∏¢‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î */
    }

    .score-summary {
      width: 100%;
      text-align: center;
      font-size: 1.14em;
      margin-top: 12px;
      margin-bottom: 5px;
      color: #159988;
      background: #e0f7fae6;
      border-radius: 11px;
      padding: 9px 0 7px 0;
      font-weight: 600;
      box-shadow: 0 1px 9px #b2dfdb24;
      letter-spacing: 0.5px;
    }

    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î */
    .high-score-summary {
      width: 100%;
      text-align: center;
      font-size: 1.14em;
      margin-top: 8px;
      margin-bottom: 5px;
      color: #fff;
      background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
      border-radius: 11px;
      padding: 9px 0 7px 0;
      font-weight: 600;
      box-shadow: 0 3px 12px #4caf5033;
      letter-spacing: 0.5px;
    }

    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö EXP */
    .exp-summary {
      width: 100%;
      text-align: center;
      font-size: 1.14em;
      margin-top: 8px;
      margin-bottom: 5px;
      color: #fff;
      background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%); /* ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á */
      border-radius: 11px;
      padding: 9px 0 7px 0;
      font-weight: 600;
      box-shadow: 0 3px 12px #9c27b033;
      letter-spacing: 0.5px;
    }

    .leaderboard-preview {
      width: 100%; margin-top: 16px; margin-bottom: 5px;
      background: #f8fdfd; border-radius: 12px;
      box-shadow: 0 1px 10px #b2dfdb20;
      padding: 9px 9px 3px 9px;
      color: #0a827a;
      font-size: 1em;
    }
    .leaderboard-preview-title {
      color: #13aaa7; font-weight: bold; margin-bottom: 6px;
      font-size: 1.05em;
      letter-spacing: 0.2px;
      text-align: left;
    }
    .leaderboard-row {
      display: flex; justify-content: space-between; margin-bottom: 4px;
      font-size: 1em; font-weight: 500;
    }

    .footer {
      margin-top: auto; text-align:center; color:#9abfc1; font-size:0.97em;
      letter-spacing: 0.5px;
      padding-top: 20px;
    }

    @media (max-width:540px) {
      .main-container { max-width: 99vw; min-height: 99vh;}
      .menu-btn { font-size: 0.99em; padding: 14px 8px;}
      .logo-circle { width: 60px; height: 60px;}
      .logo-circle span { font-size: 2em;}
      .score-summary { font-size: 1em;}
      .high-score-summary { font-size: 1em;}
      .exp-summary { font-size: 1em;}
      .leaderboard-preview { font-size: 0.97em;}
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="logo-circle"><span>‡∏ø</span></div>
    <div class="app-title">MoneySkillz</div>
    <div class="app-desc">
      ‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô<br>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡πà‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!
    </div>

    <div class="score-summary" id="totalScore">
      ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤: <span id="totalScoreValue">0</span>
    </div>

    <div class="high-score-summary" id="highScore">
      üèÜ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <span id="highScoreValue">0</span>
    </div>

    <div class="exp-summary" id="totalExp">
      üåü EXP ‡∏£‡∏ß‡∏°: <span id="totalExpValue">0</span>
      <span id="userIdDisplay" style="font-size:0.7em; margin-left: 10px;"></span>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π -->
    <div class="menu-list">
      <a href="match-easy.html" class="menu-btn menu-btn-common" data-difficulty="easy">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏á‡πà‡∏≤‡∏¢</a>
      <a href="match-medium.html" class="menu-btn menu-btn-common" data-difficulty="medium">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</a>
      <a href="match-hard.html" class="menu-btn menu-btn-common" data-difficulty="hard">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏¢‡∏≤‡∏Å</a>
      <a href="timed-score.html" class="menu-btn menu-btn-timed" data-difficulty="timed">‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ï‡πâ‡∏°</a>
      <a href="leaderboard.html" class="menu-btn menu-btn-common">‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</a>
    </div>

    <!-- ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏¢‡πà‡∏≠ -->
    <div class="leaderboard-preview" id="leaderboardPreview" style="display:none;">
      <div class="leaderboard-preview-title">TOP 3 ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
      <div id="leaderboardRows"></div>
      <div style="text-align:right; margin-top:5px;">
        <a href="leaderboard.html" style="color:#11aaa7;text-decoration:underline;font-size:0.97em;">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
      </div>
    </div>

    <div class="footer">
      &copy; 2025 MoneySkillz &mdash; ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡πÇ‡∏î‡∏¢‡∏ó‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    </div>
  </div>
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Initialize Firebase with the provided configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBjLBl1sEGgQLyng51rW25b434bJ0opVc4",
      authDomain: "myapplication-bd04c034.firebaseapp.com",
      databaseURL: "https://myapplication-bd04c034-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "myapplication-bd04c034",
      storageBucket: "myapplication-bd04c034.firebasestorage.app",
      messagingSenderId: "49782830313",
      appId: "1:49782830313:web:c81b5d86a937f22d296c78"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let userId = null;
    // Note: appId is not directly used for the 'users' collection path
    // as it's assumed to be at the root level as per your Firebase console image.
    // const appId = firebaseConfig.appId; // No longer needed for this path

    // Authenticate user and listen for auth state changes
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // User is signed in (either anonymously or via custom token if it worked)
        userId = user.uid;
        document.getElementById("userIdDisplay").textContent = `(ID: ${userId.substring(0, 8)}...)`;
        console.log("User authenticated:", userId);
      } else {
        // No user signed in, sign in anonymously
        try {
          const anonymousUserCredential = await signInAnonymously(auth);
          userId = anonymousUserCredential.user.uid;
          document.getElementById("userIdDisplay").textContent = `(ID: ${userId.substring(0, 8)}...)`;
          console.log("User signed in anonymously:", userId);
        } catch (error) {
          console.error("Error signing in anonymously:", error);
          // Fallback if anonymous sign-in fails or is not yet complete
          userId = crypto.randomUUID(); 
          document.getElementById("userIdDisplay").textContent = `(ID: ${userId.substring(0, 8)} - fallback)`;
        }
      }
      // After userId is definitively set, fetch and display EXP
      await fetchAndDisplayExp();
    });

    // Function to fetch and display total EXP from Firestore
    async function fetchAndDisplayExp() {
      if (!userId) {
        console.warn("User ID not available yet for fetching EXP.");
        return;
      }
      try {
        // Changed path to directly target the user document in 'users' collection
        const userRef = doc(db, `users`, userId);
        // Use onSnapshot for real-time updates
        onSnapshot(userRef, (docSnap) => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById("totalExpValue").textContent = data.totalExp || 0;
            console.log("Total EXP fetched:", data.totalExp);
          } else {
            document.getElementById("totalExpValue").textContent = 0;
            console.log("No user data found for this ID. Initializing totalExp to 0.");
            // Initialize totalExp to 0 if the user document doesn't exist or doesn't have totalExp
            setDoc(userRef, { totalExp: 0 }, { merge: true });
          }
        }, (error) => {
          console.error("Error listening to user data:", error);
        });
      } catch (error) {
        console.error("Error setting up user data listener:", error);
      }
    }

    // Function to add EXP
    async function addExp(expAmount) {
      if (!userId) {
        console.error("Cannot add EXP: User not authenticated.");
        return;
      }
      try {
        // Changed path to directly target the user document in 'users' collection
        const userRef = doc(db, `users`, userId);
        const docSnap = await getDoc(userRef);
        let currentExp = 0;
        if (docSnap.exists()) {
          currentExp = docSnap.data().totalExp || 0;
        }
        const newExp = currentExp + expAmount;
        await setDoc(userRef, { totalExp: newExp }, { merge: true });
        console.log(`Added ${expAmount} EXP. New total: ${newExp}`);
      } catch (error) {
        console.error("Error adding EXP:", error);
      }
    }

    // Simulate game completion and add EXP (for demonstration purposes)
    // In a real game, you would call this function when a game level is completed.
    // Example: addExpForGameCompletion('easy');
    // Example: addExpForGameCompletion('timed', 100); // 100 is the score from timed mode

    const EXP_VALUES = {
      easy: 100,
      medium: 200,
      hard: 300,
      timed_multiplier: 5 // EXP multiplier for timed mode (1 point = 5 EXP)
    };

    function addExpForGameCompletion(difficulty, score = 0) {
      let expGained = 0;
      if (difficulty === 'easy') {
        expGained = EXP_VALUES.easy;
      } else if (difficulty === 'medium') {
        expGained = EXP_VALUES.medium;
      } else if (difficulty === 'hard') {
        expGained = EXP_VALUES.hard;
      } else if (difficulty === 'timed') {
        // For timed mode, score directly contributes to EXP, then multiply by the multiplier
        expGained = score * EXP_VALUES.timed_multiplier;
      }

      if (expGained > 0) {
        addExp(expGained);
      }
    }

    // Event listeners for menu buttons to simulate game completion
    document.querySelectorAll('.menu-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const difficulty = event.currentTarget.dataset.difficulty;
        if (difficulty) {
          // Simulate a small delay and then add EXP, as if a game just finished
          setTimeout(() => {
            // For demonstration, we'll assume a fixed score for timed mode completion.
            // IMPORTANT: In a real game, 'score' would need to come from the actual result
            // of the 'timed-score.html' game, possibly passed via localStorage or a query parameter.
            const score = difficulty === 'timed' ? 50 : 0; // Example score for timed mode
            addExpForGameCompletion(difficulty, score);
            console.log(`Simulated completion of ${difficulty} mode.`);
          }, 1000); // Simulate 1 second game play
        }
      });
    });


    // ‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
    function showTotalScore() {
      let val = localStorage.getItem("money_score_timed");
      document.getElementById("totalScoreValue").textContent = val ? parseInt(val) : 0;
    }

    // ‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
    function showHighScore() {
      let highScore = localStorage.getItem("arcadeHighScore");
      let highScoreValue = highScore ? parseInt(highScore) : 0;
      document.getElementById("highScoreValue").textContent = highScoreValue;
      
      // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
      if (highScoreValue === 0) {
        document.getElementById("highScore").style.display = "none";
      } else {
        document.getElementById("highScore").style.display = "block";
      }
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
    showTotalScore();
    showHighScore();

    // ‡πÅ‡∏™‡∏î‡∏á TOP 3 leaderboard (mock ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•, ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å localStorage/‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏à‡∏£‡∏¥‡∏á)
    function showLeaderboardPreview() {
      let leaderboard = JSON.parse(localStorage.getItem("money_leaderboard")||"[]");
      if(leaderboard && leaderboard.length > 0) {
        leaderboard.sort((a,b)=>b.score-a.score);
        let html = leaderboard.slice(0,3).map((r,i)=>
          `<div class="leaderboard-row"><span>${i+1}. ${r.name}</span> <span>${r.score}</span></div>`
        ).join('');
        document.getElementById("leaderboardRows").innerHTML = html;
        document.getElementById("leaderboardPreview").style.display = '';
      }
    }
    showLeaderboardPreview();
    
  </script>
  <script src="darkmode-toggle.js"></script>
</body>
</html>
