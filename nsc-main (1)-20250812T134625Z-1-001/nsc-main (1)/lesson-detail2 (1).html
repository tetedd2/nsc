<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‚Äì ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</title>
  <link rel="stylesheet" href="theme-darkmode.css" />
  <script async src="https://www.tiktok.com/embed.js"></script>
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background-color:#eaf4f4; }
    .header { background-color:#009688; color:white; padding:20px; text-align:center; }
    .container { padding:20px; max-width:800px; margin:0 auto; }
    .lesson-title { color:#004d40; font-size:1.7rem; margin-bottom:18px; }
    .lesson-content { font-size:1.07rem; color:#444; line-height:1.9; margin-bottom:24px; }
    .pagination { text-align:center; margin:28px 0 10px 0; }
    .page-btn { display:inline-block; background:#009688; color:#fff; padding:8px 20px; border-radius:7px; text-decoration:none; margin:0 12px; transition:background 0.2s; }
    .page-btn:disabled, .disabled { background:#ccc !important; color:#888; pointer-events:none; }
    .back-btn { margin-top:30px; display:inline-block; background:#009688; color:#fff; padding:10px 18px; border-radius:8px; text-decoration:none; transition:background 0.2s; }
    .save-btn { background:#009688; color:#fff; border:none; border-radius:7px; padding:10px 20px; margin-top:15px; cursor:pointer; }
    .quiz-status { margin-left:16px; font-weight:bold; }
    .video-container { margin: 24px 0; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .video-wrapper { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; }
    .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
    .end-of-chapter-quiz .question { background-color: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid #009688; }
    .end-of-chapter-quiz .question-text { font-size: 1.1em; font-weight: 600; margin-bottom: 10px; }
    .end-of-chapter-quiz .choices { display: flex; flex-direction: column; gap: 10px; }
    .end-of-chapter-quiz .choice { background-color: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 10px; cursor: pointer; display: block; }
    #quizResult.correct { color: #388e3c; }
    #quizResult.incorrect { color: #d32f2f; }

    /* Custom Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    .modal-content {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        text-align: center;
        max-width: 400px;
        width: 90%;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
    }
    .modal-overlay.show .modal-content {
        transform: translateY(0);
    }
    .modal-content h3 {
        color: #004d40;
        font-size: 1.5rem;
        margin-bottom: 15px;
    }
    .modal-content p {
        color: #333;
        font-size: 1.1rem;
        line-height: 1.6;
        margin-bottom: 25px;
        white-space: pre-wrap; /* Preserve newlines from message */
    }
    .modal-content button {
        background-color: #009688;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .modal-content button:hover {
        background-color: #00796b;
        transform: translateY(-1px);
    }
    /* Specific styles for success/error messages */
    .modal-content.success h3 { color: #388e3c; }
    .modal-content.error h3 { color: #d32f2f; }
  </style>
</head>
<body>
  <div class="header"><h1>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h1></div>
  <div class="container">
    <div id="lessonDetails"></div>
    <div class="pagination" id="pagination"></div>
    <a href="lesson.html" class="back-btn">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a>
  </div>

  <!-- Custom Alert Modal -->
  <div id="customAlertModal" class="modal-overlay">
    <div class="modal-content">
      <h3 id="modalTitle"></h3>
      <p id="modalMessage"></p>
      <button id="modalCloseBtn">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
  </div>

  <script>
    const lessonId = 2; // This should be dynamically set for each lesson page
    const urlParams = new URLSearchParams(window.location.search);
    const pageNow = Number(urlParams.get("page")||1);

    const pages = [
       {
        title: "‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏° (‡∏´‡∏ô‡πâ‡∏≤ 1/5)",
        content: `
          <div>
            <b>‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</b> ‡∏Ñ‡∏∑‡∏≠ ‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ ‡πÑ‡∏°‡πà‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï<br>
            <b>‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏°?</b>
            <ul>
              <li>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á, ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</li>
              <li>‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏¢‡∏≤‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢</li>
              <li>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß</li>
              <li>‡∏ù‡∏∂‡∏Å‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</li>
            </ul>
          </div>
        `
      },
      {
        title: "‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏´‡∏ô‡πâ‡∏≤ 2/5)",
        content: `
          <div>
            <b>‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</b><br>
            <ul>
              <li><b>‡∏≠‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ (Pay Yourself First):</b> ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏≠‡∏°‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ 10-20% ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡πà‡∏≠‡∏¢‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</li>
              <li><b>‡∏≠‡∏≠‡∏°‡πÄ‡∏®‡∏©‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç:</b> ‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡∏ß‡∏±‡∏ô ‡∏ô‡∏≥‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏≤‡∏´‡∏¢‡∏≠‡∏î‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å</li>
              <li><b>‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û:</b> ‡∏ï‡∏¥‡∏î‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡∏á‡∏ö‡∏±‡∏ô‡∏î‡∏≤‡∏•‡πÉ‡∏à</li>
            </ul>
             <div class="video-container">
              <div class="video-wrapper">
                <iframe src="https://www.youtube.com/embed/OUO2unyOv78" title="YouTube video player" allowfullscreen></iframe>
              </div>
            </div>
          </div>
        `
      },
      {
        title: "‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö SMART (‡∏´‡∏ô‡πâ‡∏≤ 3/5)",
        content: `
          <div>
            ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö <b>SMART</b>:
            <ul>
              <li><b>S (Specific):</b> ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á - ‡∏à‡∏∞‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£? (‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏π‡∏ü‡∏±‡∏á‡πÑ‡∏£‡πâ‡∏™‡∏≤‡∏¢)</li>
              <li><b>M (Measurable):</b> ‡∏ß‡∏±‡∏î‡∏ú‡∏•‡πÑ‡∏î‡πâ - ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà? (‡πÄ‡∏ä‡πà‡∏ô 1,500 ‡∏ö‡∏≤‡∏ó)</li>
              <li><b>A (Achievable):</b> ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ 500 ‡∏ö‡∏≤‡∏ó)</li>
              <li><b>R (Relevant):</b> ‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏• - ‡∏™‡∏¥‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</li>
              <li><b>T (Time-bound):</b> ‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ - ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà? (‡πÄ‡∏ä‡πà‡∏ô ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</li>
            </ul>
          </div>
        `
      },
      {
        title: "‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2: ‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏≠‡∏≤‡∏ä‡∏ô‡∏∞‡πÉ‡∏à‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡∏´‡∏ô‡πâ‡∏≤ 4/5)",
        content: `
          <div>
            <b>‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢:</b>
            <ol>
              <li><b>‡πÉ‡∏à‡∏≠‡πà‡∏≠‡∏ô:</b> ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏à‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà</li>
              <li><b>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:</b> ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡∏ó‡∏≥‡πÑ‡∏° ‡πÄ‡∏•‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏£‡∏á‡∏à‡∏π‡∏á‡πÉ‡∏à</li>
              <li><b>‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ô‡πâ‡∏≠‡∏¢:</b> ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏≠‡∏≠‡∏°</li>
            </ol>
            <b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏≠‡∏≤‡∏ä‡∏ô‡∏∞:</b>
            <ul>
                <li>‡πÉ‡∏ä‡πâ‡∏Å‡∏é "‡∏£‡∏≠ 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á" ‡∏Å‡πà‡∏≠‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</li>
                <li>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏õ‡∏∞‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡πÜ</li>
                <li>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏≠‡∏°‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡πÜ ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 5-10 ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏¥‡∏™‡∏±‡∏¢</li>
            </ul>
          </div>
        `
      },
      {
        title: "‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2: ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡πâ‡∏≤‡∏¢‡∏ö‡∏ó (‡∏´‡∏ô‡πâ‡∏≤ 5/5)",
        content: `
          <div class="end-of-chapter-quiz" id="end-of-chapter-quiz"></div>
          <button type="button" class="save-btn" id="checkQuizBtn">‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
          <span id="quizResult" class="quiz-status"></span>
          <div style="margin-top:16px;">
            <button id="doneBtn" class="save-btn disabled" style="background:#388e3c;">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö‡∏ö‡∏ó‡∏ô‡∏µ‡πâ</button>
            <span id="doneStatus" class="quiz-status"></span>
          </div>
                    <div style="margin-top: 40px; border-top: 1px solid #ddd; padding-top: 20px; text-align: left;">
  <h3>‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠</h3>
  <ul>
    <li><a href="https://www.bot.or.th/th/home.html">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢: ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</a></li>
    <li><a href="https://opec.go.th/">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô: ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°</a></li>
    <li><a href="https://www.gsb.or.th/blogs/6-%E0%B9%80%E0%B8%84%E0%B8%A5%E0%B9%87%E0%B8%94%E0%B8%A5%E0%B8%B1%E0%B8%9A%E0%B8%81%E0%B8%B2%E0%B8%A3%E0%B8%AD%E0%B8%AD%E0%B8%A1%E0%B8%AA%E0%B8%B3%E0%B8%AB%E0%B8%A3%E0%B8%B1%E0%B8%9A%E0%B8%99%E0%B9%89/" target="_blank">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô: 6 ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</a></li>
  </ul>
</div>
        `
      }
    ];

    let page = Math.min(Math.max(pageNow,1), pages.length);
    document.getElementById("lessonDetails").innerHTML = `<div class="lesson-title">${pages[page-1].title}</div><div class="lesson-content">${pages[page-1].content}</div>`;
    let pag = "";
    if (page > 1) pag += `<a class="page-btn" href="lesson-detail2.html?page=${page-1}">‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</a>`;
    if (page < pages.length) pag += `<a class="page-btn" href="lesson-detail2.html?page=${page+1}">‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</a>`;
    document.getElementById("pagination").innerHTML = pag;

    // --- Custom Modal Functions ---
    const customAlertModal = document.getElementById('customAlertModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalContent = customAlertModal.querySelector('.modal-content');

    function showCustomAlert(title, message, isSuccess = true) {
        modalTitle.textContent = title;
        modalMessage.textContent = message; // Use textContent to handle newlines naturally
        modalContent.className = 'modal-content ' + (isSuccess ? 'success' : 'error');
        customAlertModal.classList.add('show');
    }

    function hideCustomAlert() {
        customAlertModal.classList.remove('show');
    }

    modalCloseBtn.addEventListener('click', hideCustomAlert);
    // --- End Custom Modal Functions ---

    if (page === pages.length) {
      const quizData = [
          {
              question: "‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£ '‡∏≠‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ' (Pay Yourself First) ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡∏≠‡∏∞‡πÑ‡∏£?",
              choices: ["‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢", "‡∏ô‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏≠‡∏≠‡∏°", "‡∏¢‡∏∑‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏≠‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô"],
              answer: "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢"
          },
          {
              question: "‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÅ‡∏ö‡∏ö SMART ‡∏ï‡∏±‡∏ß 'T' ‡∏¢‡πà‡∏≠‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏≠‡∏∞‡πÑ‡∏£?",
              choices: ["Time-bound (‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)", "Trust (‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠)", "Tactic (‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå)", "Total (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)"],
              answer: "Time-bound (‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)"
          },
          {
              question: "‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏î‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏£‡∏á‡∏à‡∏π‡∏á‡πÉ‡∏à‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?",
              choices: ["‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô", "‡∏ö‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ü‡∏±‡∏á", "‡∏ï‡∏¥‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô", "‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢"],
              answer: "‡∏ï‡∏¥‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏õ‡∏∏‡∏Å‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô"
          }
      ];

      const quizContainer = document.getElementById('end-of-chapter-quiz');
      const checkButton = document.getElementById('checkQuizBtn');
      const resultContainer = document.getElementById('quizResult');
      const doneBtn = document.getElementById("doneBtn");
      const doneStatus = document.getElementById("doneStatus");

      function buildEndOfChapterQuiz() {
          quizData.forEach((currentQuestion, questionNumber) => {
              const choicesHTML = currentQuestion.choices.map(choice => `
                  <label class="choice">
                      <input type="radio" name="chapter_question${questionNumber}" value="${choice}">
                      ${choice}
                  </label>
              `).join('');
              const questionHTML = `
                  <div class="question">
                      <div class="question-text">${questionNumber + 1}. ${currentQuestion.question}</div>
                      <div class="choices">${choicesHTML}</div>
                  </div>
              `;
              quizContainer.innerHTML += questionHTML;
          });
      }

      function checkQuizAnswers() {
          const answerContainers = quizContainer.querySelectorAll('.choices');
          let numCorrect = 0;
          let allAnswered = true;
          quizData.forEach((currentQuestion, questionNumber) => {
              const selector = `input[name=chapter_question${questionNumber}]:checked`;
              const userAnswerNode = answerContainers[questionNumber].querySelector(selector);
              if (!userAnswerNode) { allAnswered = false; return; }
              if (userAnswerNode.value === currentQuestion.answer) numCorrect++;
          });

          if (!allAnswered) {
              resultContainer.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠";
              resultContainer.className = "quiz-status incorrect";
              doneBtn.disabled = true; // Keep done button disabled if not all questions are answered
              doneBtn.classList.add('disabled');
              return;
          }
          if (numCorrect === quizData.length) {
              resultContainer.textContent = "‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠";
              resultContainer.className = "quiz-status correct";
              doneBtn.disabled = false;
              doneBtn.classList.remove('disabled');
              doneStatus.textContent = "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß!";
          } else {
              resultContainer.textContent = `‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î! ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å ${numCorrect} ‡∏à‡∏≤‡∏Å ${quizData.length} ‡∏Ç‡πâ‡∏≠`;
              resultContainer.className = "quiz-status incorrect";
              doneBtn.disabled = true;
              doneBtn.classList.add('disabled');
              doneStatus.textContent = "";
          }
      }
      
      function finishLesson() {
        if (window.completeLessonInFirestore) {
            window.completeLessonInFirestore(lessonId, 80); // Award 80 XP
        } else {
            console.error("Firebase script not loaded. Saving to localStorage only.");
            localStorage.setItem(`MoneySkillz-lesson${lessonId}-done`, "yes");
            window.checkInitialDoneStatus();
            showCustomAlert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!");
        }
      }

      window.checkInitialDoneStatus = function() {
          if (localStorage.getItem(`MoneySkillz-lesson${lessonId}-done`) === "yes") {
              doneStatus.innerHTML = "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö‡∏ö‡∏ó‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß!";
              doneBtn.disabled = true;
              doneBtn.classList.add('disabled');
              if(checkButton) checkButton.style.display = 'none';
              if(resultContainer) resultContainer.style.display = 'none';
          }
      }

      buildEndOfChapterQuiz();
      checkButton.addEventListener('click', checkQuizAnswers);
      doneBtn.addEventListener('click', finishLesson);
      window.checkInitialDoneStatus();
    }
  </script>

  <script type="module">
    // Firebase SDK Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, runTransaction, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBjLBl1sEGgQLyng51rW25b434bJ0opVc4",
      authDomain: "myapplication-bd04c034.firebaseapp.com",
      projectId: "myapplication-bd04c034",
      storageBucket: "myapplication-bd04c034.appspot.com",
      messagingSenderId: "49782830313",
      appId: "1:49782830313:web:c81b5d86a937f22d296c78"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // XP & Leveling System Configuration
    const LEVEL_CONFIG = [
        { level: 1, name: "‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô", xpToNext: 100 },
        { level: 2, name: "‡∏ô‡∏±‡∏Å‡∏≠‡∏≠‡∏°‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î", xpToNext: 250 },
        { level: 3, name: "‡∏ô‡∏±‡∏Å‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç", xpToNext: 500 },
        { level: 4, name: "‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô", xpToNext: 1000 },
        { level: 5, name: "‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà", xpToNext: Infinity },
    ];

    /**
     * Main function to grant XP, check for level-ups, and save data to Firestore.
     * @param {string} uid - Firebase User ID.
     * @param {number} amount - Amount of XP to add.
     * @param {number} lessonId - ID of the recently completed lesson.
     * @returns {Promise<{success: boolean, message: string, isSuccessStatus: boolean}>} - Result and message to display.
     */
    async function grantXpAndLevelUp(uid, amount, lessonId) {
        if (!uid || !amount || amount <= 0) return { success: false, message: "Invalid input.", isSuccessStatus: false };
        
        const userRef = doc(db, 'users', uid);
        let finalMessage = `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${amount} XP`;
        let isSuccessStatus = true; // To determine modal style

        try {
            await runTransaction(db, async (transaction) => {
                const userSnap = await transaction.get(userRef);
                if (!userSnap.exists()) throw new Error("User document not found.");

                const userData = userSnap.data();
                const completedLessons = userData.completedLessons || [];
                if (completedLessons.includes(lessonId)) {
                    console.log(`Lesson ${lessonId} already completed. No XP awarded.`);
                    finalMessage = "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö‡∏ö‡∏ó‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö XP ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß";
                    isSuccessStatus = false; // Not a new success
                    return; 
                }

                let xp = userData.xp || 0;
                let level = userData.level || 1;
                let nextLevelXP = userData.nextLevelXP || LEVEL_CONFIG[0].xpToNext;
                let totalCoinReward = 0;
                
                xp += amount;
                
                while (xp >= nextLevelXP && nextLevelXP !== Infinity) {
                    const currentLevelIndex = LEVEL_CONFIG.findIndex(l => l.level === level);
                    if (currentLevelIndex < LEVEL_CONFIG.length - 1) {
                        const nextLevelInfo = LEVEL_CONFIG[currentLevelIndex + 1];
                        const rewardForThisLevel = 100 + (nextLevelInfo.level * 25); // Calculate reward
                        totalCoinReward += rewardForThisLevel;
                        xp -= nextLevelXP; // Deduct XP used for level up
                        level = nextLevelInfo.level; // Update new level
                        nextLevelXP = nextLevelInfo.xpToNext; // Set XP for next level
                        finalMessage += `\nüéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏≠‡∏±‡∏û‡πÄ‡∏õ‡πá‡∏ô Level ${level} ‚Äì ${nextLevelInfo.name}!`;
                    } else {
                        break; // Max level reached
                    }
                }
                
                const finalUpdateData = {
                    xp: xp,
                    level: level,
                    nextLevelXP: nextLevelXP,
                    completedLessons: arrayUnion(lessonId)
                };

                if (totalCoinReward > 0) {
                    finalUpdateData.coins = increment(totalCoinReward);
                    finalMessage += `\n‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${totalCoinReward} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç!`;
                }
                
                transaction.update(userRef, finalUpdateData);
            });
            
            return { success: true, message: finalMessage, isSuccessStatus: isSuccessStatus };
        } catch (error) {
            console.error("Error in transaction: ", error);
            return { success: false, message: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", isSuccessStatus: false };
        }
    }

    /**
     * Function called from the "Finish Lesson" button to start the XP granting process.
     * @param {number} lessonId - Lesson ID.
     * @param {number} xpToAdd - XP to grant.
     */
    window.completeLessonInFirestore = async (lessonId, xpToAdd) => {
        const doneBtn = document.getElementById("doneBtn");
        const doneStatus = document.getElementById("doneStatus");
        
        if (doneBtn.disabled) return;
        doneBtn.disabled = true;
        doneStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        
        const user = auth.currentUser;
        if (user) {
            const result = await grantXpAndLevelUp(user.uid, xpToAdd, lessonId);
            
            // Use custom alert instead of browser alert
            showCustomAlert(result.success ? "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!" : "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", result.message, result.isSuccessStatus);
            doneStatus.textContent = result.message.split('\n')[0]; // Show only the first line on status

            if(result.success) {
                localStorage.setItem(`MoneySkillz-lesson${lessonId}-done`, "yes");
                if (window.checkInitialDoneStatus) {
                    window.checkInitialDoneStatus();
                }
            } else {
                doneBtn.disabled = false;
            }
        } else {
            showCustomAlert("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö XP", false);
            doneBtn.disabled = false;
            doneStatus.textContent = "‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
        }
    };

    onAuthStateChanged(auth, (user) => {
        const doneBtn = document.getElementById("doneBtn");
        const doneStatus = document.getElementById("doneStatus");

        if (doneBtn) {
            if (!user) {
                console.log("User is not logged in.");
                doneBtn.disabled = true;
                doneBtn.classList.add('disabled');
                doneBtn.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"; // Set button text directly
                doneStatus.textContent = ""; // Clear status if logged out
            } else {
                console.log("User is logged in.", user.uid);
                // Re-enable if conditions are met, otherwise check status via checkInitialDoneStatus
                if (window.checkInitialDoneStatus) {
                    window.checkInitialDoneStatus(); // This will enable/disable based on local storage
                }
                // If the button is not disabled by checkInitialDoneStatus, set its text back
                if (!doneBtn.disabled) {
                    doneBtn.textContent = "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö‡∏ö‡∏ó‡∏ô‡∏µ‡πâ";
                }
            }
        }
    });
  </script>
  <script src="darkmode-toggle.js"></script>
</body>
</html>
