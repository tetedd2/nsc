<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>üí∞ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ - MoneySkillz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* =================================
       ‡∏£‡∏ß‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏à‡∏≤‡∏Å add-transaction.css ‡πÅ‡∏•‡∏∞‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Message Box
       ================================= */

    :root {
      /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô */
      --primary-color: #26A69A;
      --primary-darker: #00796B;
      --background-color: #f4f7f6;
      --card-background: #ffffff;
      --text-color: #333;
      --text-secondary: #666;
      --border-color: #e0e0e0;
      --shadow-color: rgba(0, 100, 100, 0.15);
      --highlight-color: rgba(38, 166, 154, 0.2);
      --danger-color: #f44336;
    }

    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dark Mode (‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï) */
    body.dark-mode {
      --background-color: #1a1a1a;
      --card-background: #282828;
      --text-color: #e0e0e0;
      --text-secondary: #aaaaaa;
      --border-color: #444;
      --shadow-color: rgba(0, 0, 0, 0.4);
    }

    /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Kanit', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
    }

    /* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (Header) */
    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-darker));
      color: white;
      padding: 40px 20px 80px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 1.1em;
      font-weight: 300;
      opacity: 0.9;
    }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå */
    .avatar-box {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: var(--card-background);
      box-shadow: 0 4px 15px var(--shadow-color);
      border: 4px solid var(--card-background);
      position: absolute;
      bottom: -50px;
      left: 50%;
      transform: translateX(-50%);
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .avatar-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö */
    .back-btn {
      position: absolute;
      top: 35px;
      left: 25px;
      background: rgba(255, 255, 255, 0.9);
      color: #00796B;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      z-index: 10;
    }

    .back-btn:hover {
      background: #ffffff;
      transform: scale(1.05);
    }

    .back-btn .arrow {
      font-size: 1.8em;
      font-weight: bold;
      line-height: 1;
    }

    /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏° */
    .container.card-section.form-box {
      background-color: var(--card-background);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 25px var(--shadow-color);
      margin: 0 auto;
      margin-top: 80px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å Header */
      margin-bottom: 30px;
      max-width: 550px;
      width: 90%;
    }

    .form-box h2 {
      text-align: center;
      color: var(--primary-darker);
      margin-bottom: 25px;
      font-size: 1.6em;
      font-weight: 600;
    }

    body.dark-mode .form-box h2 {
        color: var(--highlight-color);
    }

    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ü‡∏≠‡∏£‡πå‡∏° */
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-secondary);
      font-size: 1em;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--background-color);
      color: var(--text-color);
      font-size: 1rem;
      font-family: 'Kanit', sans-serif;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px var(--highlight-color);
    }
    
    input:disabled, select:disabled, textarea:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    textarea {
        resize: vertical;
    }

    /* ‡∏õ‡∏∏‡πà‡∏° Submit */
    .submit-btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 8px;
      background-color: var(--primary-color);
      color: white;
      font-size: 1.2em;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .submit-btn:hover {
      background-color: var(--primary-darker);
      transform: translateY(-2px);
    }
    
    .submit-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
    }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô */
    .message-box {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      text-align: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .message-box.show {
        display: flex;
        opacity: 1;
    }
    .message-box-content {
      background-color: var(--card-background, white);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 400px;
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.3s ease-out;
    }
    .message-box.show .message-box-content {
      transform: scale(1);
      opacity: 1;
    }
    .message-box-content p {
      font-size: 1.1em;
      margin-bottom: 25px;
      color: var(--text-color, #333);
    }
    .message-box-content button {
      background-color: var(--primary-color);
      color: white;
      padding: 10px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
    }
    .message-box-content.success { border-top: 5px solid #4CAF50; }
    .message-box-content.error { border-top: 5px solid var(--danger-color); }
    .message-box-content.info { border-top: 5px solid #2196F3; }
    
    /* ‡πÅ‡∏ñ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ */
    #spending-ban-alert {
        display: none;
        padding: 15px;
        margin-bottom: 20px;
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        border-radius: 8px;
        text-align: center;
    }
  </style>
</head>
<body>

<header class="header">
    <a href="dashboard.html" class="back-btn">
      <span class="arrow">&larr;</span>
    </a>
    <h1>MoneySkillz</h1>
    <p>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
    <div class="avatar-box">
      <!-- ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏ß‡∏£‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô -->
      <img src="https://placehold.co/100x100/26A69A/FFFFFF?text=M" alt="Avatar">
    </div>
</header>

<div class="container card-section form-box">
    <h2>üí∞ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</h2>
    <div id="spending-ban-alert"></div>
    <form id="transaction-form" style="display: none;">
      <label for="type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
      <select id="type" required>
        <option value="expense" selected>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
        <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
      </select>

      <label for="category">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
      <select id="category" required>
        <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
      </select>

      <label for="amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
      <input type="number" id="amount" placeholder="0.00" step="0.01" min="0.01" required>

      <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" id="date" required>

      <label for="description">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
      <textarea id="description" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡πÅ‡∏ü, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" required></textarea>

      <button type="submit" id="submit-btn" class="submit-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    </form>
</div>

<div id="messageBox" class="message-box">
    <div id="messageBoxContent" class="message-box-content">
      <p id="messageText"></p>
      <button id="messageCloseBtn">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
</div>

<script type="module">
    // ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Firebase SDK v11 (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, getDoc, serverTimestamp, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ================== Firebase Configuration (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß) ==================
    const firebaseConfig = {
      apiKey: "AIzaSyBjLBl1sEGgQLyng51rW25b434bJ0opVc4",
      authDomain: "myapplication-bd04c034.firebaseapp.com",
      databaseURL: "https://myapplication-bd04c034-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "myapplication-bd04c034",
      storageBucket: "myapplication-bd04c034.appspot.com", // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç storageBucket ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      messagingSenderId: "49782830313",
      appId: "1:49782830313:web:c81b5d86a937f22d296c78"
    };

    // ================== Firebase Initialization ==================
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    // ================== DOM Elements ==================
    const transactionForm = document.getElementById('transaction-form');
    const typeSelect = document.getElementById('type');
    const categorySelect = document.getElementById('category');
    const amountInput = document.getElementById('amount');
    const dateInput = document.getElementById('date');
    const descriptionInput = document.getElementById('description');
    const submitButton = document.getElementById('submit-btn');
    const spendingBanAlert = document.getElementById('spending-ban-alert');

    // ================== Data Definitions ==================
    const categories = {
        expense: ["‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", "‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á", "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢", "‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤", "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û", "‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏¥‡∏•", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"],
        income: ["‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡∏¥‡∏°", "‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç", "‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢", "‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"]
    };

    const allBadges = [
        { id: 'first_transaction', name: '‡∏ô‡∏±‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà', description: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', icon: '‚úçÔ∏è', xp: 20, coins: 30 },
        { id: 'first_goal', name: '‡∏ú‡∏π‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢', description: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÅ‡∏£‡∏Å', icon: 'üéØ', xp: 25, coins: 50 },
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ï‡∏£‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    ];

    // ================== Functions ==================

    /**
     * ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á
     * @param {string} message - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á
     * @param {string} type - ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ('success', 'error', 'info')
     * @param {function} onConfirm - ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡∏ï‡∏Å‡∏•‡∏á'
     */
    function showMessageBox(message, type = "info", onConfirm = null) {
      const box = document.getElementById("messageBox");
      const content = document.getElementById("messageBoxContent");
      const text = document.getElementById("messageText");
      const closeBtn = document.getElementById("messageCloseBtn");

      text.textContent = message;
      content.className = 'message-box-content ' + type;
      box.classList.add("show");

      const closeHandler = () => {
        box.classList.remove("show");
        if (onConfirm) onConfirm();
      };

      // ‡πÉ‡∏ä‡πâ once: true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ event listener ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ
      closeBtn.addEventListener('click', closeHandler, { once: true });
    }

    /**
     * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô Dropdown ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
     */
    function populateCategories() {
        const selectedType = typeSelect.value;
        categorySelect.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡πà‡∏≤
        categories[selectedType].forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
        updateFormState(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    }

    /**
     * ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Input ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
     */
    function setDefaultDate() {
        dateInput.value = new Date().toISOString().split('T')[0];
    }

    /**
     * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
     */
    function initializeSpendingBanState() {
        const isBlocked = localStorage.getItem('isSpendingBlocked') === 'true';
        const expenseOption = typeSelect.querySelector('option[value="expense"]');

        if (isBlocked) {
            spendingBanAlert.textContent = 'üö® ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ';
            spendingBanAlert.style.display = 'block';
            if (expenseOption) expenseOption.disabled = true;
            if (typeSelect.value === 'expense') {
                typeSelect.value = 'income';
            }
        } else {
            spendingBanAlert.style.display = 'none';
            if (expenseOption) expenseOption.disabled = false;
        }
        populateCategories(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á category ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏°
    }
    
    /**
     * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô) ‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
     */
    function updateFormState() {
        const isBlocked = localStorage.getItem('isSpendingBlocked') === 'true';
        const isExpense = typeSelect.value === 'expense';
        const shouldBeDisabled = isBlocked && isExpense;

        submitButton.disabled = shouldBeDisabled;
        amountInput.disabled = shouldBeDisabled;
        descriptionInput.disabled = shouldBeDisabled;
        categorySelect.disabled = shouldBeDisabled;
    }

    /**
     * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏°‡∏≠‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
     * @param {string} uid - User ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
     * @param {string} badgeId - ID ‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ï‡∏£‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
     */
    async function checkAndAwardBadge(uid, badgeId) {
        if (!uid || !badgeId) return;

        const userDocRef = doc(db, 'users', uid);
        const userSnap = await getDoc(userDocRef);

        if (userSnap.exists()) {
            const userData = userSnap.data();
            const currentBadges = userData.badges || [];

            if (!currentBadges.includes(badgeId)) {
                const awardedBadge = allBadges.find(b => b.id === badgeId);
                if (awardedBadge) {
                    try {
                        await updateDoc(userDocRef, {
                            badges: arrayUnion(badgeId),
                            xp: increment(awardedBadge.xp || 0),
                            coins: increment(awardedBadge.coins || 0)
                        });
                        showMessageBox(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡∏°‡πà: ${awardedBadge.name}!`, "success");
                    } catch (error) {
                        console.error(`Error awarding badge ${badgeId}:`, error);
                    }
                }
            }
        }
    }

    /**
     * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
     * @param {Event} event - Event object ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ submit form
     */
    async function saveTransaction(event) {
        event.preventDefault();
        if (!currentUser) {
            showMessageBox("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "info");
            return;
        }

        const isBlocked = localStorage.getItem('isSpendingBlocked') === 'true';
        if (isBlocked && typeSelect.value === 'expense') {
            showMessageBox('‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ', 'error');
            return;
        }

        const transaction = {
            type: typeSelect.value,
            category: categorySelect.value,
            amount: parseFloat(amountInput.value),
            date: dateInput.value,
            description: descriptionInput.value.trim(),
            createdAt: serverTimestamp()
            // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà uid ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ path ‡∏°‡∏µ uid ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
        };
        
        if (!transaction.type || !transaction.category || !transaction.amount || transaction.amount <= 0 || !transaction.date || !transaction.description) {
            showMessageBox("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "error");
            return;
        }

        submitButton.disabled = true;
        submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

        try {
            // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô subcollection ‡∏Ç‡∏≠‡∏á user ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô ***
            const docRef = await addDoc(collection(db, 'users', currentUser.uid, 'transactions'), transaction);
            
            const userRef = doc(db, 'users', currentUser.uid);
            await updateDoc(userRef, {
                xp: increment(10),
                lastActivity: serverTimestamp()
            });

            await checkAndAwardBadge(currentUser.uid, 'first_transaction');

            showMessageBox("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö 10 XP!", "success", () => {
                window.location.href = "dashboard.html";
            });

        } catch (error) {
            console.error("Error adding document: ", error);
            showMessageBox("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + error.message, "error");
            submitButton.disabled = false;
            submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
        }
    }

    // ================== Event Listeners & Initial Setup ==================

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            transactionForm.style.display = 'block';
            initializeSpendingBanState();
        } else {
            currentUser = null;
            console.log("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô, ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô...");
            signInAnonymously(auth).catch(err => {
                console.error("‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
                showMessageBox("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", "error");
            });
        }
    });

    typeSelect.addEventListener('change', populateCategories);
    transactionForm.addEventListener('submit', saveTransaction);
    
    document.addEventListener("DOMContentLoaded", () => {
      setDefaultDate();
    });

</script>
<script src="darkmode-toggle.js"></script>
</body>
</html>
