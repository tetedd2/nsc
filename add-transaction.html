<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>üí∞ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ - MoneySkillz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* =================================
       ‡∏£‡∏ß‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏à‡∏≤‡∏Å add-transaction.css ‡πÅ‡∏•‡∏∞‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Message Box
       ================================= */

    :root {
      /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡πà‡∏ô */
      --primary-color: #26A69A;
      --primary-darker: #00796B;
      --background-color: #f4f7f6;
      --card-background: #ffffff;
      --text-color: #333;
      --text-secondary: #666;
      --border-color: #e0e0e0;
      --shadow-color: rgba(0, 100, 100, 0.15);
      --highlight-color: rgba(38, 166, 154, 0.2);
      --danger-color: #f44336;
      --warning-color: #ff9800;
    }

    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dark Mode (‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï) */
    body.dark-mode {
      --background-color: #1a1a1a;
      --card-background: #282828;
      --text-color: #e0e0e0;
      --text-secondary: #aaaaaa;
      --border-color: #444;
      --shadow-color: rgba(0, 0, 0, 0.4);
    }

    /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Kanit', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
    }

    /* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (Header) */
    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-darker));
      color: white;
      padding: 40px 20px 80px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 1.1em;
      font-weight: 300;
      opacity: 0.9;
    }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå */
    .avatar-box {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: var(--card-background);
      box-shadow: 0 4px 15px var(--shadow-color);
      border: 4px solid var(--card-background);
      position: absolute;
      bottom: -50px;
      left: 50%;
      transform: translateX(-50%);
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .avatar-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö */
    .back-btn {
      position: absolute;
      top: 35px;
      left: 25px;
      background: rgba(255, 255, 255, 0.9);
      color: #00796B;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      z-index: 10;
    }

    .back-btn:hover {
      background: #ffffff;
      transform: scale(1.05);
    }

    .back-btn .arrow {
      font-size: 1.8em;
      font-weight: bold;
      line-height: 1;
    }

    /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏° */
    .container.card-section.form-box {
      background-color: var(--card-background);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 25px var(--shadow-color);
      margin: 0 auto;
      margin-top: 80px;
      margin-bottom: 30px;
      max-width: 550px;
      width: 90%;
    }

    .form-box h2 {
      text-align: center;
      color: var(--primary-darker);
      margin-bottom: 25px;
      font-size: 1.6em;
      font-weight: 600;
    }

    body.dark-mode .form-box h2 {
        color: var(--highlight-color);
    }

    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ü‡∏≠‡∏£‡πå‡∏° */
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-secondary);
      font-size: 1em;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--background-color);
      color: var(--text-color);
      font-size: 1rem;
      font-family: 'Kanit', sans-serif;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px var(--highlight-color);
    }
    
    input:disabled, select:disabled, textarea:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
        opacity: 0.6;
    }

    textarea {
        resize: vertical;
    }

    /* ‡∏õ‡∏∏‡πà‡∏° Submit */
    .submit-btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 8px;
      background-color: var(--primary-color);
      color: white;
      font-size: 1.2em;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .submit-btn:hover:not(:disabled) {
      background-color: var(--primary-darker);
      transform: translateY(-2px);
    }
    
    .submit-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
    }

    /* ‡πÅ‡∏ñ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ */
    #spending-ban-alert {
        display: none;
        padding: 15px;
        margin-bottom: 20px;
        background-color: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô */
    .emergency-btn {
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        border: none;
        border-radius: 8px;
        background-color: var(--warning-color);
        color: white;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .emergency-btn:hover {
        background-color: #f57c00;
    }

    .emergency-note {
        display: block;
        margin-top: 8px;
        font-size: 0.9em;
        color: var(--text-secondary);
        text-align: center;
    }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô */
    .message-box {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      text-align: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .message-box.show {
        display: flex;
        opacity: 1;
    }
    
    .message-box-content {
      background-color: var(--card-background, white);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 400px;
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.3s ease-out;
    }
    
    .message-box.show .message-box-content {
      transform: scale(1);
      opacity: 1;
    }
    
    .message-box-content p {
      font-size: 1.1em;
      margin-bottom: 25px;
      color: var(--text-color, #333);
    }
    
    .message-box-content button {
      background-color: var(--primary-color);
      color: white;
      padding: 10px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      margin: 0 5px;
    }
    
    .message-box-content button:hover {
      background-color: var(--primary-darker);
    }
    
    .message-box-content.success { 
      border-top: 5px solid #4CAF50; 
    }
    
    .message-box-content.error { 
      border-top: 5px solid var(--danger-color); 
    }
    
    .message-box-content.info { 
      border-top: 5px solid #2196F3; 
    }

    /* Emergency Modal Styles */
    #emergencyModal textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-family: 'Kanit', sans-serif;
        font-size: 1rem;
        margin: 10px 0;
    }

    #emergencyModal .modal-title {
        font-size: 1.3em;
        font-weight: 600;
        color: var(--warning-color);
        margin-bottom: 15px;
    }

    #emergencyModal .button-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }

    .cancel-btn {
        background-color: #999 !important;
    }

    .cancel-btn:hover {
        background-color: #777 !important;
    }
  </style>
</head>
<body>

<header class="header">
    <a href="dashboard.html" class="back-btn">
      <span class="arrow">&larr;</span>
    </a>
    <h1>MoneySkillz</h1>
    <p>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
    <div class="avatar-box">
      <img src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" alt="Avatar">
    </div>
</header>

<div class="container card-section form-box">
    <h2>üí∞ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</h2>
    
    <!-- ‡πÅ‡∏ñ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ -->
    <div id="spending-ban-alert">
        üö® ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 30% - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
    </div>
    
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô -->
    <div id="emergency-controls" style="display:none;">
        <button type="button" id="openEmergencyModal" class="emergency-btn">
            ‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
        </button>
        <small class="emergency-note">
            *‡πÇ‡∏´‡∏°‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÇ‡∏î‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
        </small>
    </div>
    
    <form id="transaction-form" style="display: none;">
      <label for="type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
      <select id="type" required>
        <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
        <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
      </select>

      <label for="category">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
      <select id="category" required>
        <!-- ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
      </select>

      <label for="amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
      <input type="number" id="amount" placeholder="0.00" step="0.01" min="0.01" required>

      <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" id="date" required>

      <label for="description">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
      <textarea id="description" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡πÅ‡∏ü, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" required></textarea>

      <input type="hidden" id="isEmergency" value="false" />
      <input type="hidden" id="emergencyReason" value="" />
      
      <button type="submit" id="submit-btn" class="submit-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    </form>
</div>

<!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏™‡πà‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô -->
<div id="emergencyModal" class="message-box">
    <div class="message-box-content info">
        <div class="modal-title">‚ö†Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</div>
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</p>
        <textarea id="emergencyReasonInput" rows="4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)"></textarea>
        <div class="button-group">
            <button id="confirmEmergencyBtn" class="submit-btn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            <button id="cancelEmergencyBtn" class="cancel-btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>

<!-- Modal ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ -->
<div id="messageBox" class="message-box">
    <div id="messageBoxContent" class="message-box-content">
      <p id="messageText"></p>
      <button id="messageCloseBtn">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
</div>

<script type="module">
    // ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, getDoc, query, where, getDocs, serverTimestamp, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ================== Firebase Configuration ==================
    const firebaseConfig = {
      apiKey: "AIzaSyBjLBl1sEGgQLyng51rW25b434bJ0opVc4",
      authDomain: "myapplication-bd04c034.firebaseapp.com",
      databaseURL: "https://myapplication-bd04c034-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "myapplication-bd04c034",
      storageBucket: "myapplication-bd04c034.firebasestorage.app",
      messagingSenderId: "49782830313",
      appId: "1:49782830313:web:c81b5d86a937f22d296c78"
    };

    // ================== Firebase Initialization ==================
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    // ================== DOM Elements ==================
    const transactionForm = document.getElementById('transaction-form');
    const typeSelect = document.getElementById('type');
    const categorySelect = document.getElementById('category');
    const amountInput = document.getElementById('amount');
    const dateInput = document.getElementById('date');
    const descriptionInput = document.getElementById('description');
    const submitButton = document.getElementById('submit-btn');
    const spendingBanAlert = document.getElementById('spending-ban-alert');
    const emergencyControls = document.getElementById('emergency-controls');
    const emergencyModal = document.getElementById('emergencyModal');

    // ================== Data Definitions ==================
    const categories = {
        expense: ["‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", "‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á", "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢", "‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤", "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û", "‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏¥‡∏•", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"],
        income: ["‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡∏¥‡∏°", "‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç", "‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢", "‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"]
    };

    const allBadges = [
        { id: 'first_transaction', name: '‡∏ô‡∏±‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà', description: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì', icon: '‚úèÔ∏è', xp: 20, coins: 30 }
    ];

    // ================== Utility Functions ==================
    function showMessageBox(message, type = "info", callback = null) {
        const messageBox = document.getElementById('messageBox');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageText = document.getElementById('messageText');
        const closeBtn = document.getElementById('messageCloseBtn');

        messageText.textContent = message;
        messageBoxContent.className = `message-box-content ${type}`;
        messageBox.classList.add('show');

        closeBtn.onclick = () => {
            messageBox.classList.remove('show');
            if (callback) callback();
        };

        messageBox.onclick = (e) => {
            if (e.target === messageBox) {
                messageBox.classList.remove('show');
                if (callback) callback();
            }
        };
    }

    // ================== Transaction Quota Check ==================
    async function checkTransactionQuota(uid) {
        if (!uid) return 0;
        
        try {
            const today = new Date().toISOString().split('T')[0];
            const transactionsRef = collection(db, 'users', uid, 'transactions');
            const todayQuery = query(transactionsRef, where('date', '==', today));
            const snapshot = await getDocs(todayQuery);
            return snapshot.size;
        } catch (error) {
            console.error("Error checking transaction quota:", error);
            return 0;
        }
    }

    // ================== Financial Status Check ==================
    async function checkSavingsPercentage(uid) {
        if (!uid) return 100; // Default to 100% if no user
        
        try {
            // Method 1: Try to get data from user document first
            const userDocRef = doc(db, 'users', uid);
            const userSnap = await getDoc(userDocRef);
            
            if (userSnap.exists()) {
                const userData = userSnap.data();
                const storedIncome = userData.totalIncome || 0;
                const storedExpenses = userData.totalExpenses || 0;
                
                console.log(`Stored data - Income: ${storedIncome}, Expenses: ${storedExpenses}`);
                
                if (storedIncome > 0) {
                    const savings = storedIncome - storedExpenses;
                    const savingsPercentage = (savings / storedIncome) * 100;
                    console.log(`From stored data - Savings percentage: ${savingsPercentage}%`);
                    return Math.max(0, savingsPercentage);
                }
            }
            
            // Method 2: Calculate from transactions if no stored data
            console.log('No stored financial data, calculating from transactions...');
            const transactionsRef = collection(db, 'users', uid, 'transactions');
            const snapshot = await getDocs(transactionsRef);
            
            let totalIncome = 0;
            let totalExpenses = 0;
            
            snapshot.forEach(doc => {
                const transaction = doc.data();
                const amount = parseFloat(transaction.amount) || 0;
                
                if (transaction.type === 'income') {
                    totalIncome += amount;
                } else if (transaction.type === 'expense') {
                    totalExpenses += amount;
                }
            });
            
            console.log(`Calculated from transactions - Income: ${totalIncome}, Expenses: ${totalExpenses}`);
            
            if (totalIncome > 0) {
                const savings = totalIncome - totalExpenses;
                const savingsPercentage = (savings / totalIncome) * 100;
                console.log(`Calculated savings percentage: ${savingsPercentage}%`);
                
                // Update user document with calculated totals
                await updateDoc(userDocRef, {
                    totalIncome: totalIncome,
                    totalExpenses: totalExpenses
                });
                
                return Math.max(0, savingsPercentage);
            } else {
                console.log('No income found, returning 100%');
                return 100; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ 100% (‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î)
            }
        } catch (error) {
            console.error("Error checking savings percentage:", error);
            return 100; // Default to safe value
        }
    }

    async function updateSpendingRestriction(uid) {
        const savingsPercentage = await checkSavingsPercentage(uid);
        const isBlocked = savingsPercentage < 30;
        
        // Update localStorage for spending restriction
        localStorage.setItem('isSpendingBlocked', isBlocked.toString());
        localStorage.setItem('currentSavingsPercentage', savingsPercentage.toString());
        
        console.log(`Savings percentage: ${savingsPercentage}%, Is blocked: ${isBlocked}`);
        
        return isBlocked;
    }

    // ================== Emergency Management ==================
    function isEmergencyMode() {
        return sessionStorage.getItem('emergencyOverride') === 'true';
    }

    function setEmergencyMode(reason) {
        sessionStorage.setItem('emergencyOverride', 'true');
        sessionStorage.setItem('emergencyReason', reason || '');
    }

    function clearEmergencyMode() {
        sessionStorage.removeItem('emergencyOverride');
        sessionStorage.removeItem('emergencyReason');
    }

    function populateCategories() {
        const selectedType = typeSelect.value;
        categorySelect.innerHTML = '';
        categories[selectedType].forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
        updateFormState();
    }

    function setDefaultDate() {
        dateInput.value = new Date().toISOString().split('T')[0];
    }

    function updateFormState() {
        const isBlocked = localStorage.getItem('isSpendingBlocked') === 'true';
        const savingsPercentage = parseFloat(localStorage.getItem('currentSavingsPercentage') || '100');
        const isExpense = typeSelect.value === 'expense';
        const isEmergency = isEmergencyMode();
        
        console.log(`Form state - IsBlocked: ${isBlocked}, SavingsPercentage: ${savingsPercentage}, IsExpense: ${isExpense}, IsEmergency: ${isEmergency}`);
        
        // Update spending ban alert text with current percentage
        const alertElement = document.getElementById('spending-ban-alert');
        alertElement.innerHTML = `üö® ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° ${savingsPercentage.toFixed(1)}% (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 30%) - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢`;
        
        // Show/hide spending restriction UI only when:
        // 1. Spending is blocked (savings < 30%)
        // 2. User is trying to add expense
        // 3. Emergency mode is not active
        if (isBlocked && isExpense && !isEmergency) {
            spendingBanAlert.style.display = 'block';
            emergencyControls.style.display = 'block';
            
            // Disable form fields
            submitButton.disabled = true;
            submitButton.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ';
            amountInput.disabled = true;
            descriptionInput.disabled = true;
            categorySelect.disabled = true;
        } else {
            // Hide restriction UI when savings >= 30% OR not expense OR emergency mode active
            spendingBanAlert.style.display = 'none';
            emergencyControls.style.display = 'none';
            
            // Enable form fields
            submitButton.disabled = false;
            submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
            amountInput.disabled = false;
            descriptionInput.disabled = false;
            categorySelect.disabled = false;
        }
        
        // Update hidden fields
        document.getElementById('isEmergency').value = isEmergency ? 'true' : 'false';
        document.getElementById('emergencyReason').value = isEmergency ? (sessionStorage.getItem('emergencyReason') || '') : '';
    }

    async function checkAndAwardBadge(uid, badgeId) {
        if (!uid || !badgeId) return;

        const userDocRef = doc(db, 'users', uid);
        const userSnap = await getDoc(userDocRef);

        if (userSnap.exists()) {
            const userData = userSnap.data();
            const currentBadges = userData.badges || [];

            if (!currentBadges.includes(badgeId)) {
                const awardedBadge = allBadges.find(b => b.id === badgeId);
                if (awardedBadge) {
                    try {
                        await updateDoc(userDocRef, {
                            badges: arrayUnion(badgeId),
                            xp: increment(awardedBadge.xp || 0),
                            coins: increment(awardedBadge.coins || 0)
                        });
                        showMessageBox(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ï‡∏£‡∏≤‡πÉ‡∏´‡∏°‡πà: ${awardedBadge.name}!`, "success");
                    } catch (error) {
                        console.error(`Error awarding badge ${badgeId}:`, error);
                    }
                }
            }
        }
    }

    async function saveTransaction(event) {
        event.preventDefault();
        
        if (!currentUser) {
            showMessageBox("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "info");
            return;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
        const transactionCount = await checkTransactionQuota(currentUser.uid);

        // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏£‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô
        if (transactionCount >= 10) {
            showMessageBox('‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏£‡∏ö 10 ‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 'error');
            return;
        }

        // Check current financial status
        await updateSpendingRestriction(currentUser.uid);
        
        const isBlocked = localStorage.getItem('isSpendingBlocked') === 'true';
        const isEmergency = isEmergencyMode();
        
        if (isBlocked && typeSelect.value === 'expense' && !isEmergency) {
            const savingsPercentage = parseFloat(localStorage.getItem('currentSavingsPercentage') || '0');
            showMessageBox(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° ${savingsPercentage.toFixed(1)}% (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 30%)`, 'error');
            return;
        }

        const transaction = {
            type: typeSelect.value,
            category: categorySelect.value,
            amount: parseFloat(amountInput.value),
            date: dateInput.value,
            description: descriptionInput.value.trim(),
            createdAt: serverTimestamp(),
            isEmergency: isEmergency,
            emergencyReason: isEmergency ? (sessionStorage.getItem('emergencyReason') || '') : ''
        };
        
        if (!transaction.type || !transaction.category || !transaction.amount || 
            transaction.amount <= 0 || !transaction.date || !transaction.description) {
            showMessageBox("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", "error");
            return;
        }

        submitButton.disabled = true;
        submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

        try {
            // Add transaction to Firestore
            await addDoc(collection(db, 'users', currentUser.uid, 'transactions'), transaction);
            
            // Update user stats
            const userRef = doc(db, 'users', currentUser.uid);
            const updateData = {
                xp: increment(10),
                lastActivity: serverTimestamp()
            };

            // Update income/expense totals
            if (transaction.type === 'income') {
                updateData.totalIncome = increment(transaction.amount);
            } else {
                updateData.totalExpenses = increment(transaction.amount);
            }

            await updateDoc(userRef, updateData);

            // Check and award badge
            await checkAndAwardBadge(currentUser.uid, 'first_transaction');

            // Clear emergency mode after successful transaction
            if (isEmergency) {
                clearEmergencyMode();
            }

            // Update spending restriction after transaction
            await updateSpendingRestriction(currentUser.uid);

            showMessageBox("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö 10 XP!", "success", () => {
                window.location.href = "dashboard.html";
            });

        } catch (error) {
            console.error("Error adding document: ", error);
            showMessageBox("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + error.message, "error");
            submitButton.disabled = false;
            submitButton.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
        }
    }

    // ================== Event Listeners ==================
    
    // Emergency Modal Controls
    document.getElementById('openEmergencyModal')?.addEventListener('click', () => {
        emergencyModal.classList.add('show');
    });

    document.getElementById('cancelEmergencyBtn')?.addEventListener('click', () => {
        emergencyModal.classList.remove('show');
        document.getElementById('emergencyReasonInput').value = '';
    });

    document.getElementById('confirmEmergencyBtn')?.addEventListener('click', () => {
        const reason = document.getElementById('emergencyReasonInput').value.trim();
        
        if (reason.length < 10) {
            showMessageBox('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'error');
            return;
        }
        
        setEmergencyMode(reason);
        emergencyModal.classList.remove('show');
        
        // Force expense type and update form
        typeSelect.value = 'expense';
        populateCategories();
        updateFormState();
        
        showMessageBox('‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'info');
    });

    // Auth State Observer
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            
            // Check spending restriction when user logs in
            console.log('User logged in, checking spending restriction...');
            await updateSpendingRestriction(user.uid);
            
            transactionForm.style.display = 'block';
            updateFormState();
        } else {
            currentUser = null;
            console.log("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô, ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô...");
            signInAnonymously(auth).catch(err => {
                console.error("‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
                showMessageBox("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", "error");
            });
        }
    });

    // Form Events
    typeSelect.addEventListener('change', () => {
        populateCategories();
        updateFormState();
    });
    
    transactionForm.addEventListener('submit', saveTransaction);
    
    // Initialize on DOM ready
    document.addEventListener("DOMContentLoaded", async () => {
        setDefaultDate();
        populateCategories();
        
        // Wait a bit for auth to initialize, then check restrictions
        setTimeout(async () => {
            if (currentUser) {
                console.log('DOM ready, checking spending restriction for existing user...');
                await updateSpendingRestriction(currentUser.uid);
                updateFormState();
            }
        }, 1000);
    });

    // Check for spending restrictions on page load
    window.addEventListener('storage', async (e) => {
        if (e.key === 'isSpendingBlocked') {
            console.log('Storage event detected, updating form state...');
            updateFormState();
        }
    });

    // Force check restrictions every 5 seconds (for debugging)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        setInterval(async () => {
            if (currentUser) {
                console.log('Periodic check - updating spending restrictions...');
                await updateSpendingRestriction(currentUser.uid);
                updateFormState();
            }
        }, 5000);
    }
</script>
</body>
</html>
